<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>支付宝扫码支付</title>
    <link rel="shortcut icon" href="https://img.alicdn.com/tfs/TB1qEwuzrj1gK0jSZFOXXc7GpXa-32-32.ico">
    <link rel="stylesheet" href="/assets/pay_page/alipay_qrcode/css/style.css">
</head>

<body>
    <main class="container">
        <article class="payment-card">
            <header class="header">
                <h1 class="payment-title">扫码支付</h1>
                <p class="payment-subtitle">请使用支付宝扫码完成支付</p>
            </header>
            <section class="order-section">
                <button class="order-toggle" onclick="toggleOrderInfo()">
                    <span class="order-toggle-text">
                        <svg class="toggle-icon" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        订单详情
                    </span>
                    <span style="color: var(--text-secondary); font-size: 0.875rem;"></span>
                </button>
                <div class="order-info" id="orderInfo">
                    <div class="info-content">
                        <div class="info-item">
                            <span class="info-label">商品名称</span>
                            <span class="info-value"><?php echo $order['subject'];?></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">订单编号</span>
                            <span class="info-value"><?php echo $order['out_trade_no'];?></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">创建时间</span>
                            <span class="info-value"><?php echo $order['create_time'];?></span>
                        </div>
                    </div>
                </div>
            </section>

            <section class="amount-display">
                <div class="amount-value">
                    <span class="amount-currency">¥</span><?php echo $order['buyer_pay_amount'];?>
                </div>
            </section>

            <section class="qr-section">
                <div class="payment-loading" id="paymentLoading">
                    <div class="payment-loading-spinner"></div>
                </div>
                <div class="qr-container">
                    <div id="qrcode" title="<?php echo $url;?>"></div>
                </div>
                <div class="button-container">
                    <button class="payment-button alipay-button" id="alipayButton" onclick="handleAlipayRedirect()">
                        <span class="button-text">打开支付宝(Alipay App)</span>
                    </button>
                    <button class="payment-button confirm-button" id="confirmButton" onclick="handleConfirmPayment()">
                        <span class="button-text">我已完成支付</span>
                    </button>
                </div>
            </section>

            <footer class="footer-tips">
                <p class="tips-text">
                    支付完成后，系统将在6秒内自动跳转，请<span class="tips-highlight">不要关闭此页面</span>
                </p>
            </footer>
        </article>
    </main>

    <!-- Toast 容器 -->
    <div class="toast-container" id="toastContainer"></div>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script>
        const paymentUrl = '<?php echo $url;?>'; // 支付链接
        // 切换订单信息显示
        const toggleOrderInfo = () => {
            const orderInfo = document.getElementById('orderInfo');
            const toggleButton = document.querySelector('.order-toggle');
            const statusText = toggleButton.querySelector('span:last-child');

            orderInfo.classList.toggle('expanded');
            toggleButton.classList.toggle('expanded');

            statusText.textContent = orderInfo.classList.contains('expanded') ? '点击收起' : '';
        };

        // 显示 Toast 提示
        const showToast = (message, type = 'info') => {
            const toastContainer = document.getElementById('toastContainer');

            // 创建 Toast 元素
            const toast = document.createElement('div');
            toast.className = 'toast';

            // 创建图标
            const icon = document.createElement('div');
            icon.className = `toast-icon ${type}`;
            icon.innerHTML = type === 'success' ? '✓' : type === 'error' ? '✕' : 'i';

            // 创建消息
            const messageElement = document.createElement('div');
            messageElement.className = 'toast-message';
            messageElement.textContent = message;

            // 组装 Toast
            toast.appendChild(icon);
            toast.appendChild(messageElement);

            // 添加到容器
            toastContainer.appendChild(toast);

            // 3秒后自动移除
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        };

        // 确认支付处理
        const handleConfirmPayment = () => {
            const paymentLoading = document.getElementById('paymentLoading');
            const confirmButton = document.getElementById('confirmButton');
            const alipayButton = document.getElementById('alipayButton');

            // 显示局部加载状态
            paymentLoading.classList.add('active');
            confirmButton.disabled = true;
            alipayButton.disabled = true;
            confirmButton.innerHTML = '<span class="button-text">正在确认支付...</span>';

            // 模拟支付确认请求
            setTimeout(() => {
                // 隐藏加载状态
                paymentLoading.classList.remove('active');

                // 显示成功提示
                showToast('支付成功！正在跳转...', 'success');

                // 更新按钮状态
                confirmButton.classList.add('success');
                confirmButton.innerHTML = '<span class="button-text">✓ 支付成功</span>';

                // 禁用支付宝按钮
                alipayButton.disabled = true;
                alipayButton.style.opacity = '0.5';
            }, 2000);
        };

        // 处理支付宝跳转
        const handleAlipayRedirect = () => {
            // 检测是否为移动设备
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            if (isMobile) {
                // 尝试打开支付宝APP
                const alipayUrl = 'alipays://platformapi/startapp?appId=20000067&url=' + paymentUrl;

                // 创建一个隐藏的iframe尝试打开APP
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = alipayUrl;
                document.body.appendChild(iframe);

                // 显示提示
                showToast('正在尝试打开支付宝...', 'info');
            } else {
                showToast('电脑端请使用手机扫描二维码', 'info');
            }
        };

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 生成二维码
            const qrcodeContainer = document.getElementById('qrcode');

            // 使用 QRCode.js 生成二维码
            QRCode.toCanvas(paymentUrl, {
                width: 280,
                height: 280,
                margin: 1
            }, (error, canvas) => {
                if (error) {
                    console.error('生成二维码失败:', error);
                    qrcodeContainer.innerHTML = '<p style="color: #ff4d4f;">二维码生成失败</p>';
                } else {
                    qrcodeContainer.appendChild(canvas);
                }
            });
        });
    </script>
</body>

</html>
